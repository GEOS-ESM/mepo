#!/usr/bin/env python

import os
import traceback
import sys
MEPO_D = os.path.join(os.path.dirname(__file__), 'mepo.d')
sys.path.insert(0, MEPO_D)
from importlib import import_module

from cmdline.parser import MepoArgParser

def version_check():
    if sys.version_info < (3, 6, 0):
        raise Exception('Python version needs to be at least 3.6.0')

def get_list_of_mepo_commands():
    cmd_dir = os.path.join(MEPO_D, 'command')
    excluded = ['__pycache__']
    return [name for name in os.listdir(cmd_dir) if name not in excluded]

if __name__ == '__main__':

    version_check()
    args = MepoArgParser().parse()

    # Dispatch table
    cmd_list = get_list_of_mepo_commands()
    d = {cmd: import_module('command.{}.{}'.format(cmd, cmd)) for cmd in cmd_list}

    # Execute run method of mepo command
    try:
        d[args.mepo_cmd].run(args)
    except Exception as e:
        traceback.print_exc()
